# Test 5

`Thread(*Client)` is called from the main thread:

``` PureBasic
;*Object\Network_Thread_ID = CreateThread(@Thread(), *Object)
;If Not *Object\Network_Thread_ID
;  FreeMutex(*Object\Mutex) : *Object\Mutex = #Null
;  If *Object\ClientQueueSemaphore : FreeSemaphore(*Object\ClientQueueSemaphore) : *Object\ClientQueueSemaphore = #Null : EndIf
;  CloseNetworkServer(*Object\Server_ID) : *Object\Server_ID = #Null
;  FreeStructure(*Object)
;  ProcedureReturn #Null
;EndIf

If *Event_Thread_Callback
  *Object\Event_Thread_ID = CreateThread(@Thread_Events(), *Object)
  If Not *Object\Event_Thread_ID
    *Object\Free = #True
  ProcedureReturn #Null
  EndIf
EndIf

Thread(*Object)
```

This is exactly the same setup as test 1.

About half an hour after bombarding each of 4 servers with 250 clients reconnecting and sending packets non stop, the purifier stopped 2 servers for the same reason (~10 minutes apart):

``` text
[16:51:30] Executable-Typ: Windows - x64  (64bit, Unicode, Thread, Purifier)
[16:51:30] Executable gestartet.
[17:26:09] [ERROR] WebSocket_Server.pbi (Zeile: 943)
[17:26:09] [ERROR] Overflow in a dynamically allocated memory block.
```

Line of error (Without any meaning, as it is from a different thread):

``` PureBasic
; #### Wait for client queue entries.
ClientQueueWait(*Object)
```

## Allocations

Allocation dump at the moment of the crash.

- Allocation #1 from line 689, Size 2048: RX frame memory

    ``` PureBasic
    *TempFrame\Data = AllocateMemory(#Frame_Data_Size_Min) ; This will be purged when the client is deleted or when the server is freed, otherwise it will be reused in RX_Frame.
    ```

    Raw data, plus 8 bytes before and 8 bytes after:

    ``` text
    00000000051374DC  00 46 00 88 0D F0 AD 0B 82 81 2F D0 F5 90 7B D0  .F..ð­./Ðõ{Ð
    00000000051374EC  F5 90 00 00 00 00 00 00 00 00 00 00 00 00 00 00  õ..............
    00000000051374FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513750C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513751C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513752C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513753C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513754C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513755C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513756C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513757C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513758C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513759C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375AC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375BC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375CC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375DC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375EC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051375FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513760C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513761C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513762C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513763C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513764C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513765C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513766C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513767C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513768C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513769C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376AC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376BC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376CC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376DC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376EC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051376FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513770C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513771C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513772C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513773C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513774C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513775C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513776C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513777C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513778C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513779C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377AC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377BC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377CC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377DC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377EC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051377FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513780C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513781C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513782C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513783C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513784C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513785C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513786C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513787C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513788C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513789C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378AC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378BC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378CC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378DC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378EC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051378FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513790C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513791C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513792C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513793C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513794C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513795C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513796C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513797C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513798C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000513799C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379AC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379BC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379CC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379DC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379EC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00000000051379FC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A0C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A1C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A2C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A3C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A4C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A5C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A6C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A7C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A8C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137A9C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137AAC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137ABC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137ACC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137ADC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137AEC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137AFC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B0C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B1C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B2C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B3C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B4C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B5C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B6C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B7C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B8C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137B9C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BAC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BBC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BCC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BDC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BEC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137BFC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C0C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C1C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C2C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C3C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C4C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C5C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C6C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C7C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C8C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137C9C  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137CAC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137CBC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137CCC  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000000005137CDC  00 00 00 00 00 00 00 00 0D F0 AD 0B 19 39 19 57  .........ð­..9.W
    ```

- Allocation #2 from line 995, Size 601: TX frame memory

    ``` PureBasic
    *Client\TX_Frame()\Data = AllocateMemory(10 + Payload_Size)
    ```

    Raw data, plus 8 bytes before and 8 bytes after:

    ``` text
    000000000240B24C  6E 06 00 8F 0D F0 AD 0B 81 7E 02 4F 4C 6F 72 65  n...ð­.~.OLore
    000000000240B25C  6D 20 69 70 73 75 6D 20 64 6F 6C 6F 72 20 73 69  m ipsum dolor si
    000000000240B26C  74 20 61 6D 65 74 2C 20 63 6F 6E 73 65 74 65 74  t amet, consetet
    000000000240B27C  75 72 20 73 61 64 69 70 73 63 69 6E 67 20 65 6C  ur sadipscing el
    000000000240B28C  69 74 72 2C 20 73 65 64 20 64 69 61 6D 20 6E 6F  itr, sed diam no
    000000000240B29C  6E 75 6D 79 20 65 69 72 6D 6F 64 20 74 65 6D 70  numy eirmod temp
    000000000240B2AC  6F 72 20 69 6E 76 69 64 75 6E 74 20 75 74 20 6C  or invidunt ut l
    000000000240B2BC  61 62 6F 72 65 20 65 74 20 64 6F 6C 6F 72 65 20  abore et dolore 
    000000000240B2CC  6D 61 67 6E 61 20 61 6C 69 71 75 79 61 6D 20 65  magna aliquyam e
    000000000240B2DC  72 61 74 2C 20 73 65 64 20 64 69 61 6D 20 76 6F  rat, sed diam vo
    000000000240B2EC  6C 75 70 74 75 61 2E 20 41 74 20 76 65 72 6F 20  luptua. At vero 
    000000000240B2FC  65 6F 73 20 65 74 20 61 63 63 75 73 61 6D 20 65  eos et accusam e
    000000000240B30C  74 20 6A 75 73 74 6F 20 64 75 6F 20 64 6F 6C 6F  t justo duo dolo
    000000000240B31C  72 65 73 20 65 74 20 65 61 20 72 65 62 75 6D 2E  res et ea rebum.
    000000000240B32C  20 53 74 65 74 20 63 6C 69 74 61 20 6B 61 73 64   Stet clita kasd
    000000000240B33C  20 67 75 62 65 72 67 72 65 6E 2C 20 6E 6F 20 73   gubergren, no s
    000000000240B34C  65 61 20 74 61 6B 69 6D 61 74 61 20 73 61 6E 63  ea takimata sanc
    000000000240B35C  74 75 73 20 65 73 74 20 4C 6F 72 65 6D 20 69 70  tus est Lorem ip
    000000000240B36C  73 75 6D 20 64 6F 6C 6F 72 20 73 69 74 20 61 6D  sum dolor sit am
    000000000240B37C  65 74 2E 20 4C 6F 72 65 6D 20 69 70 73 75 6D 20  et. Lorem ipsum 
    000000000240B38C  64 6F 6C 6F 72 20 73 69 74 20 61 6D 65 74 2C 20  dolor sit amet, 
    000000000240B39C  63 6F 6E 73 65 74 65 74 75 72 20 73 61 64 69 70  consetetur sadip
    000000000240B3AC  73 63 69 6E 67 20 65 6C 69 74 72 2C 20 73 65 64  scing elitr, sed
    000000000240B3BC  20 64 69 61 6D 20 6E 6F 6E 75 6D 79 20 65 69 72   diam nonumy eir
    000000000240B3CC  6D 6F 64 20 74 65 6D 70 6F 72 20 69 6E 76 69 64  mod tempor invid
    000000000240B3DC  75 6E 74 20 75 74 20 6C 61 62 6F 72 65 20 65 74  unt ut labore et
    000000000240B3EC  20 64 6F 6C 6F 72 65 20 6D 61 67 6E 61 20 61 6C   dolore magna al
    000000000240B3FC  69 71 75 79 61 6D 20 65 72 61 74 2C 20 73 65 64  iquyam erat, sed
    000000000240B40C  20 64 69 61 6D 20 76 6F 6C 75 70 74 75 61 2E 20   diam voluptua. 
    000000000240B41C  41 74 20 76 65 72 6F 20 65 6F 73 20 65 74 20 61  At vero eos et a
    000000000240B42C  63 63 75 73 61 6D 20 65 74 20 6A 75 73 74 6F 20  ccusam et justo 
    000000000240B43C  64 75 6F 20 64 6F 6C 6F 72 65 73 20 65 74 20 65  duo dolores et e
    000000000240B44C  61 20 72 65 62 75 6D 2E 20 53 74 65 74 20 63 6C  a rebum. Stet cl
    000000000240B45C  69 74 61 20 6B 61 73 64 20 67 75 62 65 72 67 72  ita kasd gubergr
    000000000240B46C  65 6E 2C 20 6E 6F 20 73 65 61 20 74 61 6B 69 6D  en, no sea takim
    000000000240B47C  61 74 61 20 73 61 6E 63 74 75 73 20 65 73 74 20  ata sanctus est 
    000000000240B48C  4C 6F 72 65 6D 20 69 70 73 75 6D 20 64 6F 6C 6F  Lorem ipsum dolo
    000000000240B49C  72 20 73 69 74 20 61 6D 65 74 2E 00 00 00 00 00  r sit amet......
    000000000240B4AC  00 0D F0 AD 0B 00 00 00 00                       ..ð­.....
    ```

- Allocation #3 from line 662, Size unknown: RX frame structure

    ``` PureBasic
    *Client\New_RX_FRAME = _AllocateStructure(Frame) ; This will be purged when the frame is fully received, when the client is deleted or when the server is freed.
    ```

    Raw data, plus 8 bytes before:

    ``` text
    000000000240D864  00 00 00 00 00 00 00 00 04 04 13 05 00 00 00 00  ................
    000000000240D874  00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00  ................
    000000000240D884  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000000240D894  0D F0 AD 0B 5E 03 E8 74 78 11 00 80 0D F0 AD 0B  .ð­.^.ètx...ð­.
    ```

There are more allocations, but i'll not list them.

## Analysis

From looking over the allocations (which are not fully provided here), the purifier stopped both servers in the exact same way (while receiving the 4096 byte random data packet) as it did in test 1.

Further testing shows that the purifier gives definitely false positives.
The following code induces the error nearly instantly:

``` PureBasic
; Just a test to see how well the purifier works with ReAllocateMemory

EnableExplicit

;Global allocationMutex = CreateMutex()

Procedure TestThread(*Dummy)
  Protected *testMem = AllocateMemory(1000)
  Protected *newMem
  Protected newSize.i
  
  Repeat
    newSize = Random(4096, 1000)
    ;LockMutex(allocationMutex)
    *newMem = ReAllocateMemory(*testMem, newSize)
    ;UnlockMutex(allocationMutex)
    If Not *newMem
      FreeMemory(*testMem)
      Debug "ReAllocateMemory failed"
      Break
    EndIf
    *testMem = *newMem
    
    Debug *testMem
    
  ForEver
EndProcedure

Define i
For i = 1 To 10
  CreateThread(@TestThread(), #Null)
Next

OpenConsole()
Input()
```
